{% extends "livedata-base-page.html" %}
{% block header %}
{{ super() }}
<style>
    /* Tab styling */
    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        border-radius: 8px 8px 0 0;
    }

    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
        font-size: 16px;
        font-weight: bold;
    }

    .tab button:hover {
        background-color: #ddd;
    }

    .tab button.active {
        background-color: #FF6E1E;
        color: white;
    }

    /* Tab content styling */
    .tabcontent {
        display: none;
        padding: 20px;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 8px 8px;
        background-color: #fafafa;
    }

    /* Control groups */
    .control-group {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .control-group h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 2px solid #FF6E1E;
        padding-bottom: 8px;
    }

    /* Button styling */
    .btn {
        background-color: #FF6E1E;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        margin: 5px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn:hover {
        background-color: #e55a0c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .btn.btn-success {
        background-color: #28a745;
    }

    .btn.btn-success:hover {
        background-color: #218838;
    }

    .btn.btn-danger {
        background-color: #dc3545;
    }

    .btn.btn-danger:hover {
        background-color: #c82333;
    }

    .btn.btn-secondary {
        background-color: #6c757d;
    }

    .btn.btn-secondary:hover {
        background-color: #5a6268;
    }

    /* Input styling */
    .form-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin: 5px;
        transition: border-color 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #FF6E1E;
        box-shadow: 0 0 5px rgba(255, 110, 30, 0.3);
    }

    /* Control mode styling */
    .control-mode {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .radio-group {
        display: flex;
        align-items: center;
        gap: 5px;
        background-color: #f8f9fa;
        padding: 8px 12px;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .radio-group input[type="radio"] {
        margin-right: 5px;
    }

    /* Status indicators */
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-connected {
        background-color: #28a745;
    }

    .status-disconnected {
        background-color: #dc3545;
    }

    .status-on {
        background-color: #28a745;
    }

    .status-off {
        background-color: #dc3545;
    }

    /* Log box styling */
    .log-container {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
    }

    .log-box {
        width: 100%;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        background-color: #1e1e1e;
        color: #00ff00;
        border: 1px solid #333;
        border-radius: 4px;
        padding: 10px;
        resize: vertical;
    }

    /* Grid layout for controls */
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    /* Frequency controls styling */
    .frequency-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Slow start grid */
    .slow-start-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .parameter-input {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .parameter-input label {
        font-weight: bold;
        color: #555;
    }

    /* Connection status */
    .connection-status {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        font-weight: bold;
    }

    /* Power status */
    .power-status {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        font-weight: bold;
    }
</style>
<script type="text/javascript">

</script>
{% endblock %}
{% block content %}
<div class="tab">
    <button class="tablinks" onclick="openTab(event, 'MainControl')" id="defaultOpen">
        <i class="fa fa-cog"></i> Main Control
    </button>
    <button class="tablinks" onclick="openTab(event, 'SlowStart')">
        <i class="fa fa-play-circle"></i> Slow Start
    </button>
</div>

<div id="MainControl" class="tabcontent">
    <h2>Thales XPCDE Control</h2>
    
    <div class="controls-grid">
        <!-- Connection Control -->
        <div class="control-group">
            <h3>Connection</h3>
            <div class="connection-status">
                <span class="status-indicator status-disconnected" id="connectionIndicator"></span>
                <span id="connectionStatus">Disconnected</span>
            </div>
            <button type="button" class="btn btn-success" onclick="connectPort()">
                <i class="fa fa-plug"></i> Connect
            </button>
            <button type="button" class="btn btn-danger" onclick="disconnectPort()">
                <i class="fa fa-unlink"></i> Disconnect
            </button>
        </div>

        <!-- Power Control -->
        <div class="control-group">
            <h3>Power Control</h3>
            <div class="power-status">
                <span class="status-indicator status-off" id="powerIndicator"></span>
                <span id="powerStatus">Off</span>
            </div>
            <button type="button" class="btn btn-success" onclick="startControl()">
                <i class="fa fa-power-off"></i> Turn ON
            </button>
            <button type="button" class="btn btn-danger" onclick="stopControl()">
                <i class="fa fa-stop"></i> Turn OFF
            </button>
        </div>

        <!-- Update Interval -->
        <div class="control-group">
            <h3>Update Settings</h3>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="intervalEntry">Update Interval (s):</label>
                <input type="text" id="intervalEntry" value="1" class="form-input" style="width: 80px;">
                <button type="button" class="btn" onclick="applyInterval()">Apply</button>
            </div>
        </div>

        <!-- Frequency Control -->
        <div class="control-group">
            <h3>Frequency Control</h3>
            <div class="frequency-controls">
                <label for="freqEntry">Frequency (Hz):</label>
                <input type="text" id="freqEntry" value="50" class="form-input" style="width: 80px;">
                <button type="button" class="btn" onclick="setFrequency()">Set Freq</button>
            </div>
            <div class="frequency-controls" style="margin-top: 10px;">
                <label for="readFreq">Current Freq:</label>
                <input type="text" id="readFreq" value="--" readonly class="form-input" style="width: 80px; background-color: #f8f9fa;">
                <button type="button" class="btn btn-secondary" onclick="readFrequency()">Read Freq</button>
            </div>
        </div>
    </div>

    <!-- Control Mode -->
    <div class="control-group">
        <h3>Control Mode</h3>
        <div class="control-mode">
            <div class="radio-group">
                <input type="radio" id="tempRadio" name="controlMode" value="temp" checked>
                <label for="tempRadio">Temperature (K)</label>
                <input type="text" id="tempEntry" value="293.15" class="form-input" style="width: 100px;">
            </div>
            <div class="radio-group">
                <input type="radio" id="voltRadio" name="controlMode" value="voltage">
                <label for="voltRadio">Voltage (V)</label>
                <input type="text" id="voltEntry" value="0" class="form-input" style="width: 100px;">
            </div>
            <button type="button" class="btn" onclick="updateMode()">
                <i class="fa fa-refresh"></i> Update Mode
            </button>
        </div>
    </div>

    <!-- Log Display -->
    <div class="log-container">
        <h3>System Log</h3>
        <textarea id="logBox" rows="8" cols="40" readonly class="log-box" placeholder="System messages will appear here..."></textarea>
    </div>
</div>

<div id="SlowStart" class="tabcontent" style="display:none;">
    <h2>Slow Start Configuration</h2>
    
    <div class="control-group">
        <h3>Slow Start Parameters</h3>
        <div class="slow-start-grid">
            <div class="parameter-input">
                <label for="ssfEntry">Slow Start Factor (%):</label>
                <input type="text" id="ssfEntry" value="100" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="ss1Entry">Slow Start Time 1 (s):</label>
                <input type="text" id="ss1Entry" value="5" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="ss2Entry">Slow Start Time 2 (s):</label>
                <input type="text" id="ss2Entry" value="60" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="ss3Entry">Slow Start Time 3 (s):</label>
                <input type="text" id="ss3Entry" value="81" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="sv1Entry">Voltage Temperature Sensor 1 (mV):</label>
                <input type="text" id="sv1Entry" value="920" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="sv2Entry">Voltage Temperature Sensor 2 (mV):</label>
                <input type="text" id="sv2Entry" value="1040" class="form-input">
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button type="button" class="btn btn-success" onclick="applySlowStart()">
                <i class="fa fa-play"></i> Apply Slow Start
            </button>
            <button type="button" class="btn btn-danger" onclick="endSlowStart()">
                <i class="fa fa-stop"></i> End Slow Start
            </button>
        </div>
    </div>
</div>

<script>
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}
document.getElementById("defaultOpen").click();

// Helper to log messages with better formatting
function logMsg(msg) {
    var logBox = document.getElementById("logBox");
    var timestamp = new Date().toLocaleTimeString();
    logBox.value += "[" + timestamp + "] " + msg + "\n";
    logBox.scrollTop = logBox.scrollHeight;
}

// Update connection status indicator
function updateConnectionStatus(connected) {
    var indicator = document.getElementById("connectionIndicator");
    var status = document.getElementById("connectionStatus");
    if (connected) {
        indicator.className = "status-indicator status-connected";
        status.textContent = "Connected";
    } else {
        indicator.className = "status-indicator status-disconnected";
        status.textContent = "Disconnected";
    }
}

// Update power status indicator
function updatePowerStatus(on) {
    var indicator = document.getElementById("powerIndicator");
    var status = document.getElementById("powerStatus");
    if (on) {
        indicator.className = "status-indicator status-on";
        status.textContent = "On";
    } else {
        indicator.className = "status-indicator status-off";
        status.textContent = "Off";
    }
}

// Control functions with enhanced feedback
function connectPort() {
    fetch("/control/thales/connect", {method: "POST"})
        .then(r => r.text())
        .then(response => {
            logMsg(response);
            if (response.includes("Connected")) {
                updateConnectionStatus(true);
            }
        })
        .catch(err => {
            logMsg("Connection failed: " + err);
            updateConnectionStatus(false);
        });
}

function disconnectPort() {
    fetch("/control/thales/disconnect", {method: "POST"})
        .then(r => r.text())
        .then(response => {
            logMsg(response);
            updateConnectionStatus(false);
        });
}

function setFrequency() {
    var freq = document.getElementById("freqEntry").value;
    if (freq < 30 || freq > 100) {
        logMsg("Warning: Frequency should be between 30-100 Hz");
    }
    fetch("/control/thales/set_frequency", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({frequency: freq})
    }).then(r => r.text()).then(logMsg);
}

function readFrequency() {
    fetch("/control/thales/read_frequency", {method: "POST"})
        .then(r => r.text()).then(data => {
            document.getElementById("readFreq").value = data;
            logMsg("Read frequency: " + data + " Hz");
        });
}

function updateMode() {
    var mode = document.querySelector('input[name="controlMode"]:checked').value;
    var temp = document.getElementById("tempEntry").value;
    var volt = document.getElementById("voltEntry").value;
    fetch("/control/thales/update_mode", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({mode: mode, temp: temp, volt: volt})
    }).then(r => r.text()).then(logMsg);
}

function startControl() {
    if (confirm("Are you sure you want to turn ON the cryocooler?")) {
        fetch("/control/thales/start", {method: "POST"})
            .then(r => r.text()).then(logMsg);
    }
}

function stopControl() {
    if (confirm("Are you sure you want to turn OFF the cryocooler?")) {
        fetch("/control/thales/stop", {method: "POST"})
            .then(r => r.text()).then(logMsg);
    }
}

function applySlowStart() {
    var ssf = document.getElementById("ssfEntry").value;
    var ss1 = document.getElementById("ss1Entry").value;
    var ss2 = document.getElementById("ss2Entry").value;
    var ss3 = document.getElementById("ss3Entry").value;
    var sv1 = document.getElementById("sv1Entry").value;
    var sv2 = document.getElementById("sv2Entry").value;
    
    if (confirm("Apply slow start parameters?")) {
        fetch("/control/thales/apply_slow_start", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ssf, ss1, ss2, ss3, sv1, sv2})
        }).then(r => r.text()).then(logMsg);
    }
}

function endSlowStart() {
    if (confirm("End slow start sequence?")) {
        fetch("/control/thales/end_slow_start", {method: "POST"})
            .then(r => r.text()).then(logMsg);
    }
}

function applyInterval() {
    var interval = document.getElementById("intervalEntry").value;
    logMsg("Update interval set to " + interval + " seconds (local only)");
}

// Initialize connection status
updateConnectionStatus(false);
</script>
{% endblock %}