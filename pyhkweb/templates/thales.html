{% extends "livedata-base-page.html" %}
{% block header %}
{{ super() }}
<link rel="stylesheet" href="{{url_for('static', filename='dygraph-2.1.0.css')}}">
<script src="{{url_for('static', filename='dygraph-2.1.0-modjrh.min.js')}}"></script>
<script src="{{url_for('static', filename='plot_helpers.js')}}"></script>
<style>
    /* Tab styling */
    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        border-radius: 8px 8px 0 0;
    }

    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
        font-size: 16px;
        font-weight: bold;
    }

    .tab button:hover {
        background-color: #ddd;
    }

    .tab button.active {
        background-color: #FF6E1E;
        color: white;
    }

    /* Tab content styling */
    .tabcontent {
        display: none;
        padding: 20px;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 8px 8px;
        background-color: #fafafa;
    }

    /* Control groups */
    .control-group {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .control-group h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 2px solid #FF6E1E;
        padding-bottom: 8px;
    }

    /* Button styling */
    .btn {
        background-color: #FF6E1E;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        margin: 5px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .btn:hover {
        background-color: #e55a0c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .btn.btn-success {
        background-color: #28a745;
    }

    .btn.btn-success:hover {
        background-color: #218838;
    }

    .btn.btn-danger {
        background-color: #dc3545;
    }

    .btn.btn-danger:hover {
        background-color: #c82333;
    }

    .btn.btn-secondary {
        background-color: #6c757d;
    }

    .btn.btn-secondary:hover {
        background-color: #5a6268;
    }

    /* Input styling */
    .form-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin: 5px;
        transition: border-color 0.3s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: #FF6E1E;
        box-shadow: 0 0 5px rgba(255, 110, 30, 0.3);
    }

    /* Control mode styling */
    .control-mode {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .radio-group {
        display: flex;
        align-items: center;
        gap: 5px;
        background-color: #f8f9fa;
        padding: 8px 12px;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .radio-group input[type="radio"] {
        margin-right: 5px;
    }

    /* Status indicators */
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-connected {
        background-color: #28a745;
    }

    .status-disconnected {
        background-color: #dc3545;
    }

    .status-on {
        background-color: #28a745;
    }

    .status-off {
        background-color: #dc3545;
    }

    /* Log box styling */
    .log-container {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
    }

    .log-box {
        width: 100%;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        background-color: #1e1e1e;
        color: #00ff00;
        border: 1px solid #333;
        border-radius: 4px;
        padding: 10px;
        resize: vertical;
    }

    /* Grid layout for controls */
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    /* Frequency controls styling */
    .frequency-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Slow start grid */
    .slow-start-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .parameter-input {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .parameter-input label {
        font-weight: bold;
        color: #555;
    }

    /* Connection status */
    .connection-status {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        font-weight: bold;
    }

    /* Power status */
    .power-status {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        font-weight: bold;
    }

    /* Plot styling - matching other Dygraph plots */
    .plot-container {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    #temperaturePlot {
        width: 100%;
        height: 400px;
        position: relative;
    }

    /* Dygraph legend styling to match other plots */
    .dygraph-legend {
        width: 150px !important;
        left: 70px !important;
        top: 5px !important;
        background-color: rgba(255,255,255,0.9) !important;
        padding: 10px;
        z-index: 1000;
        font-size: 12px;
        position: absolute;
    }

    /* Two-column layout for main tab */
    .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: start;
    }

    .left-column {
        display: flex;
        flex-direction: column;
    }

    .right-column {
        display: flex;
        flex-direction: column;
    }

    /* Plot controls */
    .plot-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
</style>
<script type="text/javascript">

</script>
{% endblock %}
{% block content %}
<div class="tab">
    <button class="tablinks" onclick="openTab(event, 'MainControl')" id="defaultOpen">
        <i class="fa fa-cog"></i> Main Control
    </button>
    <button class="tablinks" onclick="openTab(event, 'SlowStart')">
        <i class="fa fa-play-circle"></i> Slow Start
    </button>
    <button class="tablinks" onclick="openTab(event, 'DataExport')">
        <i class="fa fa-download"></i> Export Data
    </button>
</div>

<div id="MainControl" class="tabcontent">
    <h2>Thales XPCDE Control</h2>
    
    <div class="main-content">
        <div class="left-column">
            <!-- Temperature Plot -->
            <div class="plot-container">
                <h3>Temperature Plot</h3>
                <div class="plot-controls">
                    <button type="button" class="btn btn-secondary" onclick="clearPlot()">
                        <i class="fa fa-trash"></i> Clear Plot
                    </button>
                    <button type="button" class="btn" id="autoPlotBtn" onclick="toggleAutoPlot()">
                        <i class="fa fa-play"></i> Start Auto-Plot
                    </button>
                    <label for="plotInterval">Plot Interval (s):</label>
                    <input type="text" id="plotInterval" value="5" class="form-input" style="width: 60px;">
                </div>
                <div id="temperaturePlot"></div>
                
                <!-- Plot Usage Instructions -->
                <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; font-size: 16px; color: #666;">
                    <p style="margin: 0; line-height: 1.4;">
                        <strong>Zoom X:</strong> click and drag horizontally<br>
                        <strong>Zoom Y:</strong> click and drag vertically<br>
                        <strong>Pan:</strong> shift+click and drag<br>
                        <strong>Reset Zoom:</strong> double click
                    </p>
                </div>
            </div>

            <!-- System Log moved here underneath the plot -->
            <div class="log-container">
                <h3>System Log</h3>
                <div style="margin-bottom: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="clearSystemLog()">
                        <i class="fa fa-trash"></i> Clear Log
                    </button>
                </div>
                <textarea id="logBox" rows="6" cols="40" readonly class="log-box" placeholder="System messages will appear here..."></textarea>
            </div>
        </div>

        <div class="right-column">
            <div class="controls-grid">
                <!-- Connection Control -->
                <div class="control-group">
                    <h3>Connection</h3>
                    <div class="connection-status">
                        <span class="status-indicator status-disconnected" id="connectionIndicator"></span>
                        <span id="connectionStatus">Disconnected</span>
                    </div>
                    <button type="button" class="btn btn-success" onclick="connectPort()">
                        <i class="fa fa-plug"></i> Connect
                    </button>
                    <button type="button" class="btn btn-danger" onclick="disconnectPort()">
                        <i class="fa fa-unlink"></i> Disconnect
                    </button>
                </div>

                <!-- Power Control -->
                <div class="control-group">
                    <h3>Controller On/Off </h3>
                    <div class="power-status">
                        <span class="status-indicator status-off" id="powerIndicator"></span>
                        <span id="powerStatus">Off</span>
                    </div>
                    <button type="button" class="btn btn-success" onclick="startControl()">
                        <i class="fa fa-power-off"></i> Turn ON
                    </button>
                    <button type="button" class="btn btn-danger" onclick="stopControl()">
                        <i class="fa fa-stop"></i> Turn OFF
                    </button>
                </div>
            </div>

            <!-- Current Readings -->
            <div class="control-group">
                <h3>Current Readings</h3>
                <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px;">
                    <div class="frequency-controls">
                        <label for="readTemp">Temperature (K):</label>
                        <input type="text" id="readTemp" value="--" readonly class="form-input" style="width: 100px; background-color: #f8f9fa;">
                        <button type="button" class="btn btn-secondary" onclick="readTemperature()">Read Temp</button>
                    </div>
                    <div class="frequency-controls">
                        <label for="readVolt">Voltage (mV):</label>
                        <input type="text" id="readVolt" value="--" readonly class="form-input" style="width: 100px; background-color: #f8f9fa;">
                        <button type="button" class="btn btn-secondary" onclick="readVoltage()">Read Voltage</button>
                    </div>
                    <div class="frequency-controls">
                        <label for="readFreqCurrent">Frequency (Hz):</label>
                        <input type="text" id="readFreqCurrent" value="--" readonly class="form-input" style="width: 80px; background-color: #f8f9fa;">
                        <button type="button" class="btn btn-secondary" onclick="readFrequency()">Read Freq</button>
                    </div>
                </div>
            </div>

            <!-- Control Mode -->
            <div class="control-group">
                <h3>Control Mode</h3>
                <div class="control-mode">
                    <div class="radio-group">
                        <input type="radio" id="tempRadio" name="controlMode" value="temp" checked>
                        <label for="tempRadio">Temperature (K)</label>
                        <input type="text" id="tempEntry" value="293.15" class="form-input" style="width: 100px;">
                        <label for="maxVoltEntry" style="margin-left: 10px;">Max Voltage (V):</label>
                        <input type="text" id="maxVoltEntry" value="0" class="form-input" style="width: 60px;">
                    </div>
                    <div class="radio-group">
                        <input type="radio" id="voltRadio" name="controlMode" value="voltage">
                        <label for="voltRadio">Voltage Only (V)</label>
                        <input type="text" id="voltEntry" value="0" class="form-input" style="width: 100px;">
                    </div>
                    <button type="button" class="btn" onclick="updateMode()">
                        <i class="fa fa-refresh"></i> Update Mode
                    </button>
                </div>
            </div>

            <!-- Frequency Control -->
            <div class="control-group">
                <h3>Frequency Control</h3>
                <div class="frequency-controls">
                    <label for="freqEntry">Frequency (Hz):</label>
                    <input type="text" id="freqEntry" value="50" class="form-input" style="width: 80px;">
                    <button type="button" class="btn" onclick="setFrequency()">Set Freq</button>
                </div>
            </div>

            <!-- PID Control -->
            <div class="control-group">
                <h3>PID Control Settings</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="parameter-input">
                        <label for="kpEntry">Proportional Gain (Kp):</label>
                        <input type="text" id="kpEntry" value="1.0" class="form-input" 
                               min="1.0" max="8.0" step="0.1">
                        <small style="color: #666;">Range: 1.0 - 8.0</small>
                    </div>
                    <div class="parameter-input">
                        <label for="kiEntry">Integration Gain (Ki):</label>
                        <input type="text" id="kiEntry" value="0.1" class="form-input" 
                               min="0.1" max="0.85" step="0.05">
                        <small style="color: #666;">Range: 0.1 - 0.85</small>
                    </div>
                </div>
                <div class="frequency-controls">
                    <button type="button" class="btn" onclick="setPIDGains()">Set PID Gains</button>
                    <button type="button" class="btn btn-secondary" onclick="readPIDGains()">Read Current PID</button>
                </div>
                <div style="margin-top: 10px;">
                    <label for="readyWindowEntry">Ready Window (mV):</label>
                    <input type="text" id="readyWindowEntry" value="10.0" class="form-input" style="width: 80px;">
                    <button type="button" class="btn btn-secondary" onclick="setReadyWindow()">Set</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="SlowStart" class="tabcontent" style="display:none;">
    <h2>Slow Start Configuration</h2>
    
    <div class="control-group">
        <h3>Slow Start Parameters</h3>
        <div class="slow-start-grid">
            <div class="parameter-input">
                <label for="ssfEntry">Slow Start Factor (%):</label>
                <input type="text" id="ssfEntry" value="100" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="ss1Entry">Slow Start Time 1 (s):</label>
                <input type="text" id="ss1Entry" value="5" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="ss2Entry">Slow Start Time 2 (s):</label>
                <input type="text" id="ss2Entry" value="60" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="ss3Entry">Slow Start Time 3 (s):</label>
                <input type="text" id="ss3Entry" value="81" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="sv1Entry">Voltage Temperature Sensor 1 (mV):</label>
                <input type="text" id="sv1Entry" value="920" class="form-input">
            </div>
            <div class="parameter-input">
                <label for="sv2Entry">Voltage Temperature Sensor 2 (mV):</label>
                <input type="text" id="sv2Entry" value="1040" class="form-input">
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button type="button" class="btn btn-success" onclick="applySlowStart()">
                <i class="fa fa-play"></i> Apply Slow Start
            </button>
            <button type="button" class="btn btn-danger" onclick="endSlowStart()">
                <i class="fa fa-stop"></i> End Slow Start
            </button>
        </div>
    </div>
</div>

<div id="DataExport" class="tabcontent" style="display:none;">
    <h2>Thales Export Data</h2>
    
    <div class="control-group">
        <h3>Export Parameters</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <h4>Date Range</h4>
                <div style="margin-bottom: 10px;">
                    <label for="exportStartDate">Start Date:</label>
                    <input type="date" id="exportStartDate" class="form-input" style="width: 150px;">
                </div>
                <div style="margin-bottom: 10px;">
                    <label for="exportEndDate">End Date:</label>
                    <input type="date" id="exportEndDate" class="form-input" style="width: 150px;">
                </div>
                <div style="margin-bottom: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="setTodayDates()">
                        <i class="fa fa-calendar"></i> Set to Today
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="setLastWeekDates()">
                        <i class="fa fa-calendar"></i> Last 7 Days
                    </button>
                </div>
            </div>
            
            <div>
                <h4>Data Selection</h4>
                <div style="margin-bottom: 10px;">
                    <label>
                        <input type="checkbox" id="exportTemperature" checked> Temperature Data
                    </label>
                </div>
                <div style="margin-bottom: 10px;">
                    <label>
                        <input type="checkbox" id="exportVoltage" checked> Voltage Data
                    </label>
                </div>
                <div style="margin-bottom: 10px;">
                    <label for="exportFormat"><strong>Export Format:</strong></label>
                    <select id="exportFormat" class="form-input">
                        <option value="csv">CSV (Comma Separated)</option>
                        <option value="txt">TXT (Tab Delimited)</option>
                    </select>
                </div>
                <div style="margin-bottom: 10px;">
                    <label>
                        <input type="checkbox" id="includeHeaders" checked> Include Column Headers
                    </label>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button type="button" class="btn btn-success" onclick="exportThalesData()">
                <i class="fa fa-download"></i> Export Data
            </button>
            <button type="button" class="btn btn-secondary" onclick="previewThalesData()">
                <i class="fa fa-eye"></i> Preview Data
            </button>
        </div>
        
        <!-- Preview area -->
        <div id="dataPreview" style="display: none; margin-top: 20px;">
            <h4>Data Preview (First 20 rows):</h4>
            <textarea id="previewText" readonly class="log-box" rows="10" style="width: 100%; color: #333; background-color: #f8f9fa;"></textarea>
        </div>
        
        <!-- Export status -->
        <div id="exportStatus" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;">
        </div>
    </div>
</div>

<script>
// Plot data storage
var temperaturePlot = null;
var temperatureData = [];
var plotStartTime = null;
var autoPlotTimer = null;
var isAutoPlotting = false;
var setpointTemperature = null;

// Custom legend formatter (matching other plots style)
function legendFormatter(data) {
    var html = '';
    for (var i = 0; i < data.series.length; i++) {
        var series = data.series[i];
        if (!series.isVisible) continue;
        
        var color = series.color;
        var label = series.label;
        var value = series.y;
        
        if (html !== '') html += '<br/>';
        html += '<span style="color: ' + color + '; font-weight: bold;">';
        html += '● ' + label + ': ';
        if (value !== null && value !== undefined) {
            html += value.toFixed(2) + ' K';
        } else {
            html += '--';
        }
        html += '</span>';
    }
    return html;
}

// Initialize the Dygraph plot
function initializePlot() {
    // Start with dummy data point to initialize the plot
    temperatureData = [[new Date(), null, null]];
    plotStartTime = Date.now();
    
    temperaturePlot = new Dygraph(
        document.getElementById("temperaturePlot"),
        temperatureData,
        {
            labels: ['Time', 'Temperature', 'Setpoint'],
            colors: ['#FF6E1E', '#dc3545'],
            strokeWidth: 2,
            drawPoints: true,
            pointSize: 3,
            connectSeparatedPoints: true,
            legend: 'always',
            legendFormatter: legendFormatter,
            ylabel: 'Temperature (K)',
            xlabel: '',
            digitsAfterDecimal: 2,
            animatedZooms: false,
            highlightCircleSize: 5,
            series: {
                'Temperature': {
                    strokePattern: null
                },
                'Setpoint': {
                    strokePattern: [5, 5], // Dashed line for setpoint
                    strokeWidth: 2
                }
            },
            axes: {
                x: {
                    valueFormatter: xValueFormatter,
                    ticker: Dygraph.dateTicker,
                    axisLabelFormatter: formatDate
                },
                y: {
                    valueFormatter: function(temp) {
                        if (temp === null || temp === undefined) return '--';
                        return temp.toFixed(2) + ' K';
                    },
                    ticker: customNumericTicks
                }
            }
        }
    );
}

// Add data point to plot
function addTemperaturePoint(temperature) {
    if (plotStartTime === null) {
        plotStartTime = Date.now();
        temperatureData = [];
    }
    
    var currentTime = new Date(); // Use JavaScript Date object like other plots
    
    // Create new data point [timestamp, temperature, setpoint]
    var dataPoint = [currentTime, temperature, setpointTemperature];
    temperatureData.push(dataPoint);
    
    // Limit data points to prevent memory issues (keep last 500 points)
    if (temperatureData.length > 500) {
        temperatureData.shift();
    }
    
    // Update the Dygraph with new data
    temperaturePlot.updateOptions({
        'file': temperatureData
    });
}

// Clear the plot data
function clearPlot() {
    plotStartTime = null;
    temperatureData = [[new Date(), null, null]];
    
    if (temperaturePlot) {
        temperaturePlot.updateOptions({
            'file': temperatureData
        });
    }
    
    logMsg("Plot data cleared");
}

// Toggle auto-plotting
function toggleAutoPlot() {
    if (isAutoPlotting) {
        stopAutoPlot();
    } else {
        startAutoPlot();
    }
}

function startAutoPlot() {
    var interval = parseFloat(document.getElementById("plotInterval").value) * 1000;
    if (interval < 1000) {
        logMsg("Warning: Plot interval too short, using 1 second minimum");
        interval = 1000;
        document.getElementById("plotInterval").value = "1";
    }
    
    isAutoPlotting = true;
    document.getElementById("autoPlotBtn").innerHTML = '<i class="fa fa-stop"></i> Stop Auto-Read';
    document.getElementById("autoPlotBtn").className = "btn btn-danger";
    
    // Read immediately, then start timer - CHANGE THIS LINE
    readAllCurrentValues();  // Changed from readTemperatureForPlot()
    autoPlotTimer = setInterval(readAllCurrentValues, interval);  // Changed from readTemperatureForPlot
    
    logMsg("Auto-reading started (temp, voltage, freq) with " + (interval/1000) + "s interval");
}

function stopAutoPlot() {
    if (autoPlotTimer) {
        clearInterval(autoPlotTimer);
        autoPlotTimer = null;
    }
    
    isAutoPlotting = false;
    document.getElementById("autoPlotBtn").innerHTML = '<i class="fa fa-play"></i> Start Auto-Read';
    document.getElementById("autoPlotBtn").className = "btn";
    
    logMsg("Auto-reading stopped");
}

// Add this missing function:
function readAllCurrentValues() {
    // Read temperature first
    fetch("/control/thales/read_temperature", {method: "POST"})
        .then(r => r.text())
        .then(data => {
            var temp = parseFloat(data);
            if (!isNaN(temp)) {
                addTemperaturePoint(temp);
                document.getElementById("readTemp").value = temp.toFixed(2);
            } else {
                document.getElementById("readTemp").value = "Error";
                logMsg("Temperature read returned: " + data);
            }
        })
        .catch(err => {
            document.getElementById("readTemp").value = "Error";
            logMsg("Temperature read error: " + err);
        });

    // Read voltage after 200ms delay
    setTimeout(() => {
        fetch("/control/thales/read_voltage", {method: "POST"})
            .then(r => r.text())
            .then(data => {
                var voltage = parseFloat(data);
                if (!isNaN(voltage)) {
                    document.getElementById("readVolt").value = voltage.toFixed(2);
                } else {
                    document.getElementById("readVolt").value = "Error";
                    logMsg("Voltage read returned: " + data);
                }
            })
            .catch(err => {
                document.getElementById("readVolt").value = "Error";
                logMsg("Voltage read error: " + err);
            });
    }, 200);

    // Read frequency after 400ms delay
    setTimeout(() => {
        fetch("/control/thales/read_frequency", {method: "POST"})
            .then(r => r.text())
            .then(data => {
                var freq = parseFloat(data);
                if (!isNaN(freq)) {
                    document.getElementById("readFreqCurrent").value = freq.toFixed(1);
                } else {
                    document.getElementById("readFreqCurrent").value = "Error";
                    logMsg("Frequency read returned: " + data);
                }
            })
            .catch(err => {
                document.getElementById("readFreqCurrent").value = "Error";
                logMsg("Frequency read error: " + err);
            });
    }, 400);
}


function initializeStatus() {
    var savedConnectionStatus = localStorage.getItem('thales_connection_status');
    var savedPowerStatus = localStorage.getItem('thales_power_status');
    var savedLogContent = localStorage.getItem('thales_system_log');
    
    if (savedConnectionStatus === 'true') {
        updateConnectionStatus(true);
    } else {
        updateConnectionStatus(false);
    }
    
    if (savedPowerStatus === 'true') {
        updatePowerStatus(true);
    } else {
        updatePowerStatus(false);
    }
    
    // Restore log content
    if (savedLogContent) {
        var logBox = document.getElementById("logBox");
        logBox.value = savedLogContent;
        logBox.scrollTop = logBox.scrollHeight;
    }
}

// Update connection status indicator and save to localStorage
function updateConnectionStatus(connected) {
    var indicator = document.getElementById("connectionIndicator");
    var status = document.getElementById("connectionStatus");
    if (connected) {
        indicator.className = "status-indicator status-connected";
        status.textContent = "Connected";
        localStorage.setItem('thales_connection_status', 'true');
    } else {
        indicator.className = "status-indicator status-disconnected";
        status.textContent = "Disconnected";
        localStorage.setItem('thales_connection_status', 'false');
    }
}

// Update power status indicator and save to localStorage
function updatePowerStatus(on) {
    var indicator = document.getElementById("powerIndicator");
    var status = document.getElementById("powerStatus");
    if (on) {
        indicator.className = "status-indicator status-on";
        status.textContent = "On";
        localStorage.setItem('thales_power_status', 'true');
    } else {
        indicator.className = "status-indicator status-off";
        status.textContent = "Off";
        localStorage.setItem('thales_power_status', 'false');
    }
}

// Control functions with enhanced feedback
function connectPort() {
    fetch("/control/thales/connect", {method: "POST"})
        .then(r => r.text())
        .then(response => {
            logMsg(response);
            if (response.includes("Connected")) {
                updateConnectionStatus(true);
            }
        })
        .catch(err => {
            logMsg("Connection failed: " + err);
            updateConnectionStatus(false);
        });
}

function disconnectPort() {
    fetch("/control/thales/disconnect", {method: "POST"})
        .then(r => r.text())
        .then(response => {
            logMsg(response);
            updateConnectionStatus(false);
        });
}

function setFrequency() {
    var freq = document.getElementById("freqEntry").value;
    if (freq < 30 || freq > 100) {
        logMsg("Warning: Frequency should be between 30-100 Hz");
    }
    fetch("/control/thales/set_frequency", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({frequency: freq})
    }).then(r => r.text()).then(logMsg);
}

function readFrequency() {
    fetch("/control/thales/read_frequency", {method: "POST"})
        .then(r => r.text()).then(data => {
            document.getElementById("readFreqCurrent").value = data;
            logMsg("Read frequency: " + data + " Hz");
        });
}

function readTemperature() {
    fetch("/control/thales/read_temperature", {method: "POST"})
        .then(r => r.text()).then(data => {
            var temp = parseFloat(data);
            if (!isNaN(temp)) {
                document.getElementById("readTemp").value = temp.toFixed(2);
                logMsg("Read temperature: " + temp.toFixed(2) + " K");
            } else {
                document.getElementById("readTemp").value = "Error";
                logMsg("Failed to read temperature: " + data);
            }
        })
        .catch(err => {
            document.getElementById("readTemp").value = "Error";
            logMsg("Temperature read error: " + err);
        });
}

function readVoltage() {
    fetch("/control/thales/read_voltage", {method: "POST"})
        .then(r => r.text()).then(data => {
            var voltage = parseFloat(data);
            if (!isNaN(voltage)) {
                document.getElementById("readVolt").value = voltage.toFixed(2);
                logMsg("Read voltage: " + voltage.toFixed(2) + " mV");
            } else {
                document.getElementById("readVolt").value = "Error";
                logMsg("Failed to read voltage: " + data);
            }
        })
        .catch(err => {
            document.getElementById("readVolt").value = "Error";
            logMsg("Voltage read error: " + err);
        });
}

function updateMode() {
    var mode = document.querySelector('input[name="controlMode"]:checked').value;
    var temp = document.getElementById("tempEntry").value;
    var volt = document.getElementById("voltEntry").value;
    var maxVolt = document.getElementById("maxVoltEntry").value;
    var kp = document.getElementById("kpEntry").value;
    var ki = document.getElementById("kiEntry").value;
    
    // Check voltage limit before sending
    if (mode === 'voltage' && parseFloat(volt) > 28) {
        logMsg("Warning: Voltage capped at 28V maximum");
        document.getElementById("voltEntry").value = "28";
        volt = "28";
    }
    
    // Check max voltage limit for temperature mode
    if (mode === 'temp' && parseFloat(maxVolt) > 28) {
        logMsg("Warning: Max voltage capped at 28V maximum");
        document.getElementById("maxVoltEntry").value = "28";
        maxVolt = "28";
    }
    
    // Store setpoint temperature for plotting
    if (mode === 'temp') {
        setpointTemperature = parseFloat(temp);
        logMsg("Setpoint temperature set to: " + temp + " K with max voltage: " + maxVolt + " V");
    } else {
        setpointTemperature = null;
        logMsg("Switched to voltage mode - setpoint tracking disabled");
    }
    
    fetch("/control/thales/update_mode", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            mode: mode, 
            temp: temp, 
            volt: volt, 
            maxVolt: maxVolt,
            kp: kp,
            ki: ki
        })
    }).then(r => r.text()).then(logMsg)
    .catch(err => logMsg("PID read error: " + err));
}

function startControl() {
    if (confirm("Are you sure you want to turn ON the cryocooler?")) {
        fetch("/control/thales/start", {method: "POST"})
            .then(r => r.text())
            .then(response => {
                logMsg(response);
                if (response.includes("ON") || response.includes("started")) {
                    updatePowerStatus(true);
                }
            });
    }
}

function stopControl() {
    if (confirm("Are you sure you want to turn OFF the cryocooler?")) {
        fetch("/control/thales/stop", {method: "POST"})
            .then(r => r.text())
            .then(response => {
                logMsg(response);
                if (response.includes("OFF") || response.includes("stopped")) {
                    updatePowerStatus(false);
                }
            });
    }
}

function applySlowStart() {
    var ssf = document.getElementById("ssfEntry").value;
    var ss1 = document.getElementById("ss1Entry").value;
    var ss2 = document.getElementById("ss2Entry").value;
    var ss3 = document.getElementById("ss3Entry").value;
    var sv1 = document.getElementById("sv1Entry").value;
    var sv2 = document.getElementById("sv2Entry").value;
    
    if (confirm("Apply slow start parameters?")) {
        fetch("/control/thales/apply_slow_start", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ssf, ss1, ss2, ss3, sv1, sv2})
        }).then(r => r.text()).then(logMsg);
    }
}

function endSlowStart() {
    if (confirm("End slow start sequence?")) {
        fetch("/control/thales/end_slow_start", {method: "POST"})
            .then(r => r.text()).then(logMsg);
    }
}

// Stop auto-update when page is unloaded
window.addEventListener('beforeunload', function() {
    stopAutoPlot();
});

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("defaultOpen").click();
    initializeStatus();
    initializePlot();
});

// Add missing helper functions:
function logMsg(message) {
    var logBox = document.getElementById("logBox");
    if (logBox) {
        var timestamp = new Date().toLocaleTimeString();
        var entry = "[" + timestamp + "] " + message + "\n";
        logBox.value += entry;
        logBox.scrollTop = logBox.scrollHeight;
        
        // Save to localStorage
        localStorage.setItem('thales_system_log', logBox.value);
    }
}

function clearSystemLog() {
    var logBox = document.getElementById("logBox");
    if (logBox) {
        logBox.value = "";
        // Also clear the localStorage
        localStorage.removeItem('thales_system_log');
        logMsg("System log cleared");
    }
}

function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

function updateMode() {
    var mode = document.querySelector('input[name="controlMode"]:checked').value;
    var temp = document.getElementById("tempEntry").value;
    var volt = document.getElementById("voltEntry").value;
    var maxVolt = document.getElementById("maxVoltEntry").value;
    var kp = document.getElementById("kpEntry").value;
    var ki = document.getElementById("kiEntry").value;
    
    // Check voltage limit before sending
    if (mode === 'voltage' && parseFloat(volt) > 28) {
        logMsg("Warning: Voltage capped at 28V maximum");
        document.getElementById("voltEntry").value = "28";
        volt = "28";
    }
    
    // Check max voltage limit for temperature mode
    if (mode === 'temp' && parseFloat(maxVolt) > 28) {
        logMsg("Warning: Max voltage capped at 28V maximum");
        document.getElementById("maxVoltEntry").value = "28";
        maxVolt = "28";
    }
    
    // Store setpoint temperature for plotting
    if (mode === 'temp') {
        setpointTemperature = parseFloat(temp);
        logMsg("Setpoint temperature set to: " + temp + " K with max voltage: " + maxVolt + " V");
    } else {
        setpointTemperature = null;
        logMsg("Switched to voltage mode - setpoint tracking disabled");
    }
    
    fetch("/control/thales/update_mode", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            mode: mode, 
            temp: temp, 
            volt: volt, 
            maxVolt: maxVolt,
            kp: kp,
            ki: ki
        })
    }).then(r => r.text()).then(logMsg)
    .catch(err => logMsg("PID read error: " + err));
}

function setReadyWindow() {
    var window = parseFloat(document.getElementById("readyWindowEntry").value);
    
    fetch("/control/thales/set_ready_window", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({window: window})
    }).then(r => r.text()).then(logMsg);
}

// Add these functions to the existing script section:
function setTodayDates() {
    var today = new Date();
    var todayStr = today.toISOString().split('T')[0];
    document.getElementById("exportStartDate").value = todayStr;
    document.getElementById("exportEndDate").value = todayStr;
    logMsg("Date range set to today: " + todayStr);
}

function setLastWeekDates() {
    var today = new Date();
    var lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    var todayStr = today.toISOString().split('T')[0];
    var lastWeekStr = lastWeek.toISOString().split('T')[0];
    document.getElementById("exportStartDate").value = lastWeekStr;
    document.getElementById("exportEndDate").value = todayStr;
    logMsg("Date range set to last 7 days: " + lastWeekStr + " to " + todayStr);
}

function validateExportParams() {
    var startDate = document.getElementById("exportStartDate").value;
    var endDate = document.getElementById("exportEndDate").value;
    var tempSelected = document.getElementById("exportTemperature").checked;
    var voltSelected = document.getElementById("exportVoltage").checked;
    
    if (!startDate || !endDate) {
        showExportStatus("Please select both start and end dates.", "error");
        return false;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        showExportStatus("Start date must be before or equal to end date.", "error");
        return false;
    }
    
    if (!tempSelected && !voltSelected) {
        showExportStatus("Please select at least one data type to export.", "error");
        return false;
    }
    
    return true;
}

function showExportStatus(message, type) {
    var statusDiv = document.getElementById("exportStatus");
    statusDiv.style.display = "block";
    statusDiv.textContent = message;
    
    if (type === "success") {
        statusDiv.style.backgroundColor = "#d4edda";
        statusDiv.style.color = "#155724";
        statusDiv.style.border = "1px solid #c3e6cb";
    } else if (type === "error") {
        statusDiv.style.backgroundColor = "#f8d7da";
        statusDiv.style.color = "#721c24";
        statusDiv.style.border = "1px solid #f5c6cb";
    } else {
        statusDiv.style.backgroundColor = "#d1ecf1";
        statusDiv.style.color = "#0c5460";
        statusDiv.style.border = "1px solid #bee5eb";
    }
    
    // Hide after 5 seconds if it's a success message
    if (type === "success") {
        setTimeout(() => {
            statusDiv.style.display = "none";
        }, 5000);
    }
}

function previewThalesData() {
    if (!validateExportParams()) {
        return;
    }
    
    showExportStatus("Loading data preview...", "info");
    logMsg("Generating data preview...");
    
    var startDate = document.getElementById("exportStartDate").value.replace(/-/g, '');
    var endDate = document.getElementById("exportEndDate").value.replace(/-/g, '');
    var tempSelected = document.getElementById("exportTemperature").checked;
    var voltSelected = document.getElementById("exportVoltage").checked;
    var includeHeaders = document.getElementById("includeHeaders").checked;
    var format = document.getElementById("exportFormat").value;
    var separator = format === "csv" ? "," : "\t";
    
    // Build the preview by fetching data from both temperature and voltage endpoints
    var promises = [];
    var dataTypes = [];
    
    if (tempSelected) {
        promises.push(fetch(`/data/export/temperature/${startDate}/${endDate}/Temperature.txt`));
        dataTypes.push('Temperature');
    }
    
    if (voltSelected) {
        promises.push(fetch(`/data/export/voltage/${startDate}/${endDate}/Voltage.txt`));
        dataTypes.push('Voltage');
    }
    
    Promise.all(promises)
        .then(responses => Promise.all(responses.map(r => r.text())))
        .then(dataArrays => {
            var combinedData = combineThalesData(dataArrays, dataTypes, separator, includeHeaders);
            var previewData = combinedData.split('\n').slice(0, 21).join('\n'); // First 20 rows + header
            
            // Update preview display based on format
            var formatLabel = format === "csv" ? "CSV" : "TXT";
            document.getElementById("dataPreview").querySelector("h4").textContent = 
                `Data Preview (First 20 rows) - ${formatLabel} Format:`;
            
            document.getElementById("previewText").value = previewData;
            document.getElementById("dataPreview").style.display = "block";
            showExportStatus(`Preview loaded successfully. Showing first 20 rows in ${formatLabel} format.`, "success");
            logMsg(`Data preview generated successfully in ${formatLabel} format`);
        })
        .catch(error => {
            showExportStatus("Failed to load preview: " + error, "error");
            logMsg("Preview error: " + error);
        });
}

function exportThalesData() {
    if (!validateExportParams()) {
        return;
    }
    
    showExportStatus("Preparing data export...", "info");
    logMsg("Starting Thales data export...");
    
    var startDate = document.getElementById("exportStartDate").value.replace(/-/g, '');
    var endDate = document.getElementById("exportEndDate").value.replace(/-/g, '');
    var tempSelected = document.getElementById("exportTemperature").checked;
    var voltSelected = document.getElementById("exportVoltage").checked;
    var includeHeaders = document.getElementById("includeHeaders").checked;
    var format = document.getElementById("exportFormat").value;
    var separator = format === "csv" ? "," : "\t";
    
    // Build the export by fetching data from both endpoints
    var promises = [];
    var dataTypes = [];
    
    if (tempSelected) {
        promises.push(fetch(`/data/export/temperature/${startDate}/${endDate}/Temperature.txt`));
        dataTypes.push('Temperature');
    }
    
    if (voltSelected) {
        promises.push(fetch(`/data/export/voltage/${startDate}/${endDate}/Voltage.txt`));
        dataTypes.push('Voltage');
    }
    
    Promise.all(promises)
        .then(responses => Promise.all(responses.map(r => r.text())))
        .then(dataArrays => {
            var combinedData = combineThalesData(dataArrays, dataTypes, separator, includeHeaders);
            
            // Create and download file with appropriate extension and MIME type
            var filename = `thales_export_${startDate}_${endDate}.${format}`;
            var mimeType = format === "csv" ? "text/csv" : "text/plain";
            downloadData(combinedData, filename, mimeType);
            
            showExportStatus(`Export completed successfully! Downloaded ${filename}`, "success");
            logMsg(`Thales data exported to ${filename}`);
        })
        .catch(error => {
            showExportStatus("Export failed: " + error, "error");
            logMsg("Export error: " + error);
        });
}

function combineThalesData(dataArrays, dataTypes, separator, includeHeaders) {
    // Parse the raw data files
    var parsedData = [];
    
    dataArrays.forEach((rawData, index) => {
        var lines = rawData.trim().split('\n');
        var dataType = dataTypes[index];
        
        lines.forEach(line => {
            if (line.trim()) {
                var parts = line.split('\t');
                if (parts.length >= 2) {
                    var timestamp = parseFloat(parts[0]);
                    var value = parseFloat(parts[1]);
                    parsedData.push({
                        timestamp: timestamp,
                        type: dataType,
                        value: value
                    });
                }
            }
        });
    });
    
    // Sort by timestamp
    parsedData.sort((a, b) => a.timestamp - b.timestamp);
    
    // Group by timestamp and create rows
    var groupedData = {};
    parsedData.forEach(point => {
        if (!groupedData[point.timestamp]) {
            groupedData[point.timestamp] = {
                timestamp: point.timestamp,
                datetime: new Date(point.timestamp * 1000).toISOString(),
                temperature: null,
                voltage: null
            };
        }
        
        if (point.type === 'Temperature') {
            groupedData[point.timestamp].temperature = point.value.toFixed(3);
        } else if (point.type === 'Voltage') {
            groupedData[point.timestamp].voltage = (point.value * 1000).toFixed(2); // Convert V to mV
        }
    });
    
    // Build output with appropriate separator
    var output = "";
    
    if (includeHeaders) {
        var headers = ["DateTime", "Unix_Timestamp"];
        if (dataTypes.includes('Temperature')) headers.push("Temperature_K");
        if (dataTypes.includes('Voltage')) headers.push("Voltage_mV");
        output += headers.join(separator) + "\n";
    }
    
    // Add data rows
    Object.values(groupedData).forEach(row => {
        var rowData = [
            row.datetime.replace('T', ' ').replace('Z', ''),
            row.timestamp.toString()
        ];
        
        if (dataTypes.includes('Temperature')) {
            rowData.push(row.temperature || "");
        }
        if (dataTypes.includes('Voltage')) {
            rowData.push(row.voltage || "");
        }
        
        output += rowData.join(separator) + "\n";
    });
    
    return output;
}

function downloadData(data, filename, mimeType) {
    var blob = new Blob([data], { type: mimeType });
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Initialize export tab dates when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates to today
    setTodayDates();
    
    // ... existing initialization code ...
});
</script>
{% endblock %}